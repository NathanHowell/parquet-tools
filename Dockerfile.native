FROM maven:3-adoptopenjdk-15@sha256:fc1f2aee3358564c86e4c0112c55f68714a29ebbb4d2bd4b1a66d7478ea01b60 AS build

ARG VERSION=1.11.1
RUN git clone --single-branch --depth=1 --branch=apache-parquet-${VERSION} https://github.com/apache/parquet-mr.git

COPY 00.patch /tmp/

WORKDIR /parquet-mr/parquet-tools
RUN patch -u -p2 < /tmp/00.patch
RUN mvn package -Plocal
RUN cp /parquet-mr/parquet-tools/target/parquet-tools-${VERSION}.jar /parquet-tools.jar

FROM adoptopenjdk/openjdk8:alpine-jre@sha256:ef78cb7ac49bd89c54cb6220eafb082a787681697a11b457f761ea8228bc98f1 AS regular

RUN apk add --no-cache tini

COPY --from=build /parquet-tools.jar /parquet-tools.jar

ENTRYPOINT ["/sbin/tini", "--", "java", "-XX:-UsePerfData", "-jar", "/parquet-tools.jar"]


FROM ghcr.io/graalvm/graalvm-ce:21.0.0.2@sha256:626b5b59717e950ab122a5d706ec2e9905e86ef3a45b3e20e41b66205afcabd2 AS graal
RUN gu install native-image

COPY reflect-config.json trace.sh users.parquet /tmp/
COPY --from=build /parquet-tools.jar /parquet-tools.jar

# make sure all commands are included
RUN /tmp/trace.sh

RUN native-image \
  -H:+ReportExceptionStackTraces \
  -H:ConfigurationFileDirectories=/config-dir \
  -H:ReflectionConfigurationFiles=/tmp/reflect-config.json \
  --allow-incomplete-classpath \
  --initialize-at-build-time=org.apache.parquet.tools.command.Registry \
  --no-fallback \
  --verbose \
  -jar /parquet-tools.jar

FROM debian:buster-slim@sha256:13f0764262a064b2dd9f8a828bbaab29bdb1a1a0ac6adc8610a0a5f37e514955 AS native

RUN apt update && apt install -y tini && apt clean

COPY --from=graal /parquet-tools /usr/bin/parquet-tools

ENTRYPOINT ["/usr/bin/tini", "--", "/usr/bin/parquet-tools"]
