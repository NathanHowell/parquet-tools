FROM maven:3-adoptopenjdk-8@sha256:bb2c2ab9cd24a13fe5f494d22c9404459613c603446b7c60afb1a945bc40aa5b AS build

ARG VERSION=1.11.1
RUN git clone --single-branch --depth=1 --branch=apache-parquet-${VERSION} https://github.com/apache/parquet-mr.git

COPY 00.patch /tmp/

WORKDIR /parquet-mr/parquet-tools
RUN patch -u -p2 < /tmp/00.patch
RUN mvn package -Plocal
RUN cp /parquet-mr/parquet-tools/target/parquet-tools-${VERSION}.jar /parquet-tools.jar

FROM adoptopenjdk/openjdk8:alpine-jre@sha256:852b67dbe831d33361fd02ee50aa4443399f850745ffe48e5fa15a2e6e81c595 AS regular

RUN apk add --no-cache tini

COPY --from=build /parquet-tools.jar /parquet-tools.jar

ENTRYPOINT ["/sbin/tini", "--", "java", "-XX:-UsePerfData", "-jar", "/parquet-tools.jar"]


FROM ghcr.io/graalvm/graalvm-ce:21.0.0.2@sha256:626b5b59717e950ab122a5d706ec2e9905e86ef3a45b3e20e41b66205afcabd2 AS graal
RUN gu install native-image

COPY reflect-config.json trace.sh users.parquet /tmp/
COPY --from=build /parquet-tools.jar /parquet-tools.jar

# make sure all commands are included
RUN /tmp/trace.sh

RUN native-image \
  -H:+ReportExceptionStackTraces \
  -H:ConfigurationFileDirectories=/config-dir \
  -H:ReflectionConfigurationFiles=/tmp/reflect-config.json \
  --allow-incomplete-classpath \
  --initialize-at-build-time=org.apache.parquet.tools.command.Registry \
  --no-fallback \
  --verbose \
  -jar /parquet-tools.jar

FROM debian:buster-slim@sha256:d4ca0a04a58b4b94d71cd4d6f865cd3474ee2b570f6338a7777fe1075ff340f5 AS native

RUN apt update && apt install -y tini && apt clean

COPY --from=graal /parquet-tools /usr/bin/parquet-tools

ENTRYPOINT ["/usr/bin/tini", "--", "/usr/bin/parquet-tools"]
